=============================================================================
ENTWICKLUNGSSTAND - PLSBL Vaadin Starter
Stand: 27.01.2026 (Abend)
=============================================================================

AKTUELLES THEMA: Sicherheits-Alarmsystem mit Kran-Stopp
-----------------------------------------------------------------------------

ZULETZT IMPLEMENTIERT (27.01.2026 Abend):
-----------------------------------------------------------------------------

1. Einheitlicher MessageService für Alarme und Meldungen

   AlarmService wurde in MessageService integriert. Der MessageService
   übernimmt jetzt:
   - Alarm-/Warnungs-/Info-Meldungen mit Historie
   - Tür-/Tor-Überwachung (checkStatus())
   - Kran-Sicherheitsstopp bei offenen Türen
   - Quittierung einzeln oder alle

   Datei: src/main/java/com/hydro/plsbl/service/MessageService.java

2. MeldungenView - System-Meldungen Tab

   Neuer Tab "Meldungen" in der Navigation zeigt alle System-Meldungen:
   - Grid mit allen Meldungen (Typ, Kategorie, Code, Text, Status, Zeit)
   - Filter nach Typ (Alle/Alarm/Warnung/Info)
   - Filter nach Status (Alle/Aktiv/Quittiert/Behoben)
   - "Alle quittieren" Button
   - Einzelne Quittieren-Buttons pro Zeile
   - Test-Button für Demo-Meldungen

   Datei: src/main/java/com/hydro/plsbl/ui/view/MeldungenView.java

3. Kran-Sicherheitsstopp bei Tür-Alarmen

   SICHERHEITSFUNKTION: Wenn ein Tor/Tür geöffnet wird:
   1. Alarm wird sofort erzeugt
   2. Kran STOPPT SOFORT (pausiert mitten in der Bewegung)
   3. AlarmBar zeigt rot blinkend "⏸ KRAN GESTOPPT"

   Kran fährt erst weiter wenn BEIDE Bedingungen erfüllt:
   - Tor ist wieder geschlossen (Bedingung behoben)
   - Alarm wurde quittiert

   Implementierung:
   a) CraneSimulatorService erweitert:
      - paused Flag
      - pause() / resume() / isPaused() Methoden
      - nextState() überspringt Bewegungen wenn pausiert
      Datei: src/main/java/com/hydro/plsbl/simulator/CraneSimulatorService.java

   b) MessageService erweitert:
      - pauseCrane() - stoppt Kran bei Tür-Alarm
      - checkAndResumeCrane() - prüft ob Kran fortgesetzt werden kann
      - acknowledge() ruft checkAndResumeCrane() nach Quittierung
      Datei: src/main/java/com/hydro/plsbl/service/MessageService.java

   c) AlarmBar erweitert:
      - Zeigt "⏸ KRAN GESTOPPT" Label wenn pausiert
      - Rot blinkend bei unquittierten Alarmen
      - Orange wenn quittiert aber Bedingung noch aktiv
      Datei: src/main/java/com/hydro/plsbl/ui/component/AlarmBar.java

4. Integration in Prozessoren

   TransportOrderProcessor und BeladungProcessorService verwenden jetzt
   MessageService statt AlarmService:
   - messageService.checkStatus() prüft Tür-Status
   - messageService.isCraneOperationAllowed() für Kran-Freigabe

   Dateien:
   - src/main/java/com/hydro/plsbl/service/TransportOrderProcessor.java
   - src/main/java/com/hydro/plsbl/service/BeladungProcessorService.java

5. Klickbare Tore im LagerGrid (Simulator-Test)

   Im Simulator-Modus können Tore im LagerGrid angeklickt werden:
   - Klick togglet Tor-Status (offen/geschlossen)
   - Grün = geschlossen, Rot = offen
   - Löst Alarm aus und stoppt Kran bei Öffnung

   Datei: src/main/java/com/hydro/plsbl/ui/component/LagerGrid.java

TESTEN DER SICHERHEITSFUNKTION:
-----------------------------------------------------------------------------

1. Anwendung starten (Simulator-Modus)
2. Beladung starten oder Transport-Auftrag erstellen
3. Während Kran fährt: Auf ein Tor im LagerGrid klicken (z.B. T1)
4. Beobachten:
   - Rote AlarmBar erscheint mit "⏸ KRAN GESTOPPT"
   - Kran stoppt sofort
5. Tor wieder schließen (erneut klicken)
6. Alarm in AlarmBar oder MeldungenView quittieren
7. Kran fährt automatisch weiter

=============================================================================

VORHERIGES THEMA: Auto-Auslagerung für MITTEL-Barren
-----------------------------------------------------------------------------

ZIEL:
- Barrentypen konfigurierbar machen (KURZ, MITTEL, LANG)
- Längenbereiche statt fester Threshold
- Berechtigungen pro Typ (intern/extern, auslagerbar, auto)
- Gewichtslimits

ABGESCHLOSSENE ARBEITEN:
-----------------------------------------------------------------------------

0. [NEU 27.01.2026] Auto-Auslagerung für MITTEL-Barren implementiert

   MITTEL-Barren (autoRetrieval=true) werden automatisch vom externen Lager
   zum Belade-Bereich angefordert, wenn ein Abruf genehmigt wird.

   a) AutoRetrievalService (NEU)
      - processCalloffApproval() - Wird bei Abruf-Genehmigung aufgerufen
      - Prüft ob Barrentyp autoRetrieval=true hat
      - Sucht passende Barren auf externen Plätzen (YARD_TYPE='E')
      - Erstellt Transport-Aufträge (Typ: Stapler) zum SWAPIN/Belade-Bereich
      - Generiert Stapler-Anforderungen für Benachrichtigung
      Datei: src/main/java/com/hydro/plsbl/service/AutoRetrievalService.java

   b) StaplerAnforderungBroadcaster (NEU)
      - Broadcaster für Stapler-Anforderungen
      - Registrierung via register() mit Consumer<List<StaplerAnforderung>>
      - Verwaltet offene Anforderungen
      - markCompleted() zum Markieren erledigter Anforderungen
      Datei: src/main/java/com/hydro/plsbl/service/StaplerAnforderungBroadcaster.java

   c) CalloffService.approve() erweitert
      - Nach Genehmigung: AutoRetrievalService.processCalloffApproval()
      - Lazy-Injection via ObjectProvider (zirkuläre Abhängigkeit vermeiden)
      - Log-Ausgabe bei erstellten Anforderungen
      Datei: src/main/java/com/hydro/plsbl/service/CalloffService.java

   d) MainLayout - Stapler-Notifications (NEU)
      - Registriert sich bei StaplerAnforderungBroadcaster
      - Zeigt Notification bei Stapler-Anforderungen (oben rechts)
      - Orange Truck-Icon, Abruf-Nummer, max. 3 Anforderungen angezeigt
      Datei: src/main/java/com/hydro/plsbl/ui/MainLayout.java

   e) Testdaten erweitert
      - 10 MITTEL-Barren (5000-6100mm) auf externen Plätzen 16/10, 17/10, 16/09, 17/09
      - StockyardStatus für externe Plätze aktualisiert
      Datei: src/main/resources/data-h2.sql

   Workflow Auto-Auslagerung:
   1. Abruf wird genehmigt (AbrufView)
   2. CalloffService.approve() ruft AutoRetrievalService auf
   3. AutoRetrievalService prüft:
      - Sind MITTEL-Barren auf externen Plätzen?
      - Haben diese Barren autoRetrieval=true?
   4. Falls ja: Transport-Aufträge für Stapler erstellen
   5. StaplerAnforderungBroadcaster sendet Notification an UI
   6. Stapler-Fahrer sieht Anforderung und holt Barren

   StaplerAnforderung Datenstruktur:
   | Feld            | Beschreibung                           |
   |-----------------|----------------------------------------|
   | transportNo     | Transportnummer (ST26-0001)            |
   | barrenNo        | Barren-Nummer                          |
   | vonPlatz        | Quell-Lagerplatz (extern)              |
   | nachPlatz       | Ziel-Lagerplatz (SWAPIN/Belade-Bereich)|
   | calloffNo       | Abruf-Nummer                           |
   | auftragNo       | Auftragsnummer                         |
   | gewicht         | Barren-Gewicht                         |
   | laenge          | Barren-Länge                           |

1. [NEU 26.01.2026] MITTEL-Barren → SWAPOUT für Stapler-Transport

   Implementiert wie im Original-System: MITTEL-Barren werden nicht intern
   gelagert, sondern auf SWAPOUT-Plätze (Ausgang 00/xx) gelegt, wo der
   Stapler sie zu externen Lagerplätzen fährt.

   a) StockyardType Enum korrigiert:
      - SWAPOUT = 'A' (war vorher 'O', AUSGANG entfernt)
      - Wie im Original-System (StockyardType.java aus plsbl-pdo)
      Datei: src/main/java/com/hydro/plsbl/entity/enums/StockyardType.java

   b) Neues Feld sawToSwapout in IngotType:
      - Wenn true: Barren wird von Säge auf SWAPOUT-Platz gelegt
      - MITTEL-Barren haben sawToSwapout=true
      Dateien: IngotType.java, IngotTypeDTO.java, IngotTypeService.java

   c) IngotStorageService.findTargetStockyard() überarbeitet:
      - Prüft sawToSwapout ZUERST (vor intern/extern)
      - Wenn sawToSwapout=true → suche SWAPOUT-Platz (00/01-00/08)
      - Neue Methode findSwapoutYard() - sucht freie Ausgang-Plätze
      - Klare Log-Ausgabe: "*** STAPLER-TRANSPORT ERFORDERLICH ***"
      Datei: src/main/java/com/hydro/plsbl/service/IngotStorageService.java

   d) Testdaten aktualisiert (data-h2.sql):
      - Plätze 00/01 bis 00/08: YARD_TYPE='A' (SWAPOUT), MAX_INGOTS=1
      - MITTEL-Barrentyp: SAW_TO_SWAPOUT=TRUE

   e) Schema aktualisiert (schema-h2.sql):
      - Neues Feld SAW_TO_SWAPOUT in MD_INGOTTYPE

   f) Kran-Visualisierung für SWAPOUT-Bereich:
      - updateCranePixelPosition() erweitert
      - Neue Konstanten: MM_SWAPOUT_Y_MIN=11530, MM_SWAPOUT_Y_MAX=30830
      - PIXEL_SWAPOUT_X = PIXEL_SAW_X (Spalte 24 Mitte)
      - Kran wird korrekt über SWAPOUT-Plätzen 00/01-00/08 angezeigt
      Datei: src/main/java/com/hydro/plsbl/ui/component/LagerGrid.java

   g) Oracle SQL-Kompatibilität:
      - TO_STOCK_ALLOWED = 1 statt = TRUE (Oracle unterstützt kein TRUE)
      Datei: src/main/java/com/hydro/plsbl/repository/StockyardRepository.java

   h) Externe Plätze von Kran-Zielen ausgeschlossen:
      - findAvailableDestinations() filtert YARD_TYPE != 'E'
      - Externe Plätze werden nicht vom Kran bedient (Stapler-Transport)
      - Verhindert ungültige Kran-Bewegungen zu externen Plätzen
      Datei: src/main/java/com/hydro/plsbl/repository/StockyardRepository.java

   i) Manuelle Umbuchung ohne Kran (für Stapler-Transport):
      - Neue Methode findAvailableDestinationsIncludingExternal()
      - UmlagernDialog: "Nur Datenbank" Modus zeigt ALLE Plätze inkl. externe
      - "Mit Kran" Modus zeigt nur Kran-erreichbare Plätze
      - Ziel-Liste wird bei Modus-Wechsel automatisch neu geladen
      - Workflow: SWAPOUT-Platz → Stapler fährt → "Nur Datenbank" auf externen Platz buchen
      Dateien: StockyardRepository.java, StockyardService.java, UmlagernDialog.java

   j) Lagerplatz-Verwaltungsdialog (NEU):
      - StockyardManagementDialog mit Filter und Bearbeitungsfunktion
      - Filter nach: Typ (Intern, Extern, SWAPOUT), Verwendung (SHORT, LONG), Text-Suche
      - Grid-Ansicht aller Lagerplätze mit Sortierung
      - Bearbeitungsformular: Typ, Verwendung, Koordinaten, Kran-Position (mm),
        Max. Barren, Ein-/Auslagern erlaubt
      - Zugriff über: Einstellungen → Stammdaten → "Lagerplätze verwalten"
      Datei: src/main/java/com/hydro/plsbl/ui/dialog/StockyardManagementDialog.java

   Workflow für MITTEL-Barren (wie Original):
   1. Barren (4300-7400mm) kommt von Säge
   2. System erkennt: sawToSwapout=true, internalAllowed=false
   3. Kran legt Barren auf SWAPOUT-Platz (00/01, 00/02, etc.)
   4. Meldung im Log: "*** STAPLER-TRANSPORT ERFORDERLICH ***"
   5. Stapler holt Barren ab und fährt zu externem Lagerplatz
   6. Manuelle Buchung im System auf externen Platz

   Barrentyp-Berechtigungen (aus Stammdaten):
   | Name   | Intern | Extern | sawToSwapout | Effekt                      |
   |--------|--------|--------|--------------|------------------------------|
   | KURZ   | Ja     | Ja     | Nein         | Normal intern einlagern      |
   | LANG   | Ja     | Ja     | Nein         | Normal intern einlagern      |
   | MITTEL | Nein   | Ja     | Ja           | → SWAPOUT für Stapler        |

2. [NEU 25.01.2026] Barrentypen-System implementiert

   a) Neue Entity: IngotType (MD_INGOTTYPE)
      - Name, Beschreibung
      - LengthType (SHORT, MEDIUM, LONG)
      - Berechtigungen: internalAllowed, externalAllowed, retrievalAllowed, autoRetrieval
      - Längenbereiche: minLength, maxLength
      - Gewichtslimits: minWeight, maxWeight
      - Regex für Produktnummer-Matching
      - Priorität
      Datei: src/main/java/com/hydro/plsbl/entity/masterdata/IngotType.java

   b) Neues Enum: LengthType (SHORT, MEDIUM, LONG)
      Datei: src/main/java/com/hydro/plsbl/entity/enums/LengthType.java

   c) Neuer Service: IngotTypeService
      - CRUD-Operationen
      - determineIngotType() - ermittelt Barrentyp basierend auf Eigenschaften
      - determineLengthType() - für Rückwärtskompatibilität
      Datei: src/main/java/com/hydro/plsbl/service/IngotTypeService.java

   d) Neuer Dialog: IngotTypeDialog
      - Liste aller Barrentypen
      - Formular zum Anlegen/Bearbeiten
      - Alle Felder konfigurierbar
      Datei: src/main/java/com/hydro/plsbl/ui/dialog/IngotTypeDialog.java

   e) SettingsView erweitert
      - Tab "Stammdaten" mit Button "Barrentypen verwalten"
      Datei: src/main/java/com/hydro/plsbl/ui/view/SettingsView.java

   f) IngotStorageService angepasst
      - Verwendet jetzt IngotTypeService für Typ-Ermittlung
      - Fallback auf alte LONG_INGOT_THRESHOLD Logik wenn kein Typ passt
      Datei: src/main/java/com/hydro/plsbl/service/IngotStorageService.java

   g) Schema erweitert
      - H2: schema-h2.sql mit MD_INGOTTYPE Tabelle
      - H2: data-h2.sql mit Standard-Barrentypen (KURZ, LANG, MITTEL)
      - Oracle: schema-ingottype.sql für Migration
      Dateien: src/main/resources/schema-h2.sql, data-h2.sql, schema-ingottype.sql

   Standard-Barrentypen (aus barrentypen.xls):
   | Name   | Typ    | Länge (mm)   | Intern | Extern | Auslagerbar | Auto |
   |--------|--------|--------------|--------|--------|-------------|------|
   | KURZ   | SHORT  | 3500-4300    | Ja     | Ja     | Ja          | Nein |
   | LANG   | LONG   | 7500-8700    | Ja     | Ja     | Nein        | Nein |
   | MITTEL | MEDIUM | 4300-7400    | Nein   | Ja     | Ja          | Ja   |

2. [NEU 25.01.2026] Produkt-Verwaltung (Stammdaten)

   a) ProductService
      Datei: src/main/java/com/hydro/plsbl/service/ProductService.java

   b) ProductDialog
      Datei: src/main/java/com/hydro/plsbl/ui/dialog/ProductDialog.java

   c) SettingsView Tab "Stammdaten" mit "Artikel verwalten"

3. [NEU 25.01.2026] Bugfix: Barren-Löschen aktualisiert UI

   a) IngotService.delete() aktualisiert jetzt StockyardStatus
      Datei: src/main/java/com/hydro/plsbl/service/IngotService.java

   b) StockyardInfoDialog ruft onRelocated Callback nach Löschen
      Datei: src/main/java/com/hydro/plsbl/ui/dialog/StockyardInfoDialog.java

4. [NEU 25.01.2026] Test-Endpunkte erweitert

   a) GET /api/test/stockyards/usage/{usage}
      - ?available=true zeigt nur verfügbare Plätze
      - Zeigt ingotCount, maxIngots pro Platz

   b) GET /api/test/stockyard/{id}
      - Details zu einem Lagerplatz

5. [NEU 25.01.2026] Duplikat-Prüfung bei Einlagerung mit globaler Fehler-Notification

   a) IngotStorageService.checkIngotNotInStock()
      - Prüft vor Einlagerung ob Barren bereits im Lager existiert
      - Nur Barren die noch im Bestand sind (stockyardId != null) werden abgelehnt
      - Bereits ausgelieferte Barren (stockyardId = null) können erneut eingelagert werden
      - Fehlermeldung enthält Lagerplatz-Nummer für einfache Identifikation
      Datei: src/main/java/com/hydro/plsbl/service/IngotStorageService.java

   b) ErrorBroadcaster Service (NEU)
      - Zentraler Service für Fehler-Broadcasting an alle UI-Listener
      - Verwendet Executor für asynchrone Benachrichtigung
      - Registrierung über register() mit Consumer<ErrorMessage>
      Datei: src/main/java/com/hydro/plsbl/service/ErrorBroadcaster.java

   c) MainLayout - Globale Fehler-Notifications
      - Registriert sich beim ErrorBroadcaster
      - Zeigt Fehler als rote Notification in der Mitte des Bildschirms
      - Funktioniert in allen Views (nicht nur SawView)
      - Auto-Close nach 10 Sekunden + manueller X-Button
      Datei: src/main/java/com/hydro/plsbl/ui/MainLayout.java

6. [NEU 25.01.2026] LagerGrid Zaun-Verbesserungen

   a) Tor 3 (T3) hinzugefügt
      - Rechts neben der Säge im oberen Zaun
      - 20px breit (wie T7)
      - Position: Spalte 27, Reihe 2

   b) Zaun-Lücken geschlossen
      - Lücke bei Spalte 21 in Reihe 16 (mittlerer Zaun)
      - Lücke oberhalb 01/10 (topFence3 erweitert auf Spalte 21)
      - Lücke unterhalb 01/02 (bottomFence2 erweitert auf Spalte 21)
      - Lücke zwischen Säge und Zaun (topFence4a erweitert auf Spalte 24)
      Datei: src/main/java/com/hydro/plsbl/ui/component/LagerGrid.java

7. [NEU 25.01.2026] Vollständiges Oracle-Schema

   a) schema-oracle.sql erstellt
      - Alle 10 Tabellen für Oracle-Produktion
      - Stammdaten: MD_APPSETTING, MD_STOCKYARD, MD_PRODUCT, MD_INGOTTYPE
      - Bewegungsdaten: TD_STOCKYARDSTATUS, TD_INGOT, TD_CRANESTATUS,
                        TD_PLSSTATUS, TD_TRANSPORTORDER, TD_CALLOFF
      - Constraints (PK, FK, UK)
      - Indizes für Performance
      - Kommentare zu Tabellen und Spalten
      - Initiale Daten (Barrentypen, Status-Einträge, Einstellungen)
      Datei: src/main/resources/schema-oracle.sql

   b) CLAUDE.md aktualisiert
      - Vollständige Datenbank-Dokumentation
      - Schema-Dateien referenziert

FRÜHERE ARBEITEN:
-----------------------------------------------------------------------------

5. [ERLEDIGT] IngotStorageService.java - Längenbasierte Lagerplatz-Auswahl
6. [ERLEDIGT] Oracle-Profil aktiviert
7. [ERLEDIGT] Oracle-Kompatibilität - NOT NULL Spalten
8. [ERLEDIGT] Transport-Nummer Format gekürzt (TA26-0001)
9. [ERLEDIGT] Kran-Visualisierung korrigiert (LONG-Lagerplätze)

ORACLE-SCHEMA:
-----------------------------------------------------------------------------

Vollständiges Oracle-Schema in: src/main/resources/schema-oracle.sql

Tabellen (10):
  Stammdaten (MD_*):
    - MD_APPSETTING      Anwendungseinstellungen
    - MD_STOCKYARD       Lagerplätze
    - MD_PRODUCT         Produkte/Artikel
    - MD_INGOTTYPE       Barrentypen (KURZ, MITTEL, LANG)

  Bewegungsdaten (TD_*):
    - TD_STOCKYARDSTATUS Lagerplatz-Status
    - TD_INGOT           Barren
    - TD_CRANESTATUS     Kran-Status (1 Eintrag)
    - TD_PLSSTATUS       Säge-Status (1 Eintrag)
    - TD_TRANSPORTORDER  Transportaufträge
    - TD_CALLOFF         Abrufe/Kundenbestellungen

Migration:
  - Neues System: Vollständiges Script ausführen (schema-oracle.sql)
  - Bestehendes System: Nur MD_INGOTTYPE hinzufügen (schema-ingottype.sql)

ZUGRIFF auf neue Funktionen:
-----------------------------------------------------------------------------

1. Einstellungen → Tab "Stammdaten" → "Barrentypen verwalten"
2. Einstellungen → Tab "Stammdaten" → "Artikel verwalten"

BUGFIXES 27.01.2026:
-----------------------------------------------------------------------------

1. [BEHOBEN] Kran legt Barren bei Beladung an falscher Position ab

   Problem: Kran legte Barren bei Position 07/02 ab statt auf dem Trailer

   Ursache: Die TRAILER-Koordinaten (45000, 9000mm) lagen im normalen
   Grid-Bereich und wurden zur visuellen Position 07/02 gemappt.

   Lösung:
   a) BeladungView.java: TRAILER-Koordinaten angepasst
      - TRAILER_X: 45000 → 40000 (Mitte Beladungsfläche)
      - TRAILER_Y: 9000 → 2000 (UNTER dem Grid, Y=1 ist bei 6270mm)
      Datei: src/main/java/com/hydro/plsbl/ui/view/BeladungView.java

   b) LagerGrid.java: Spezialfall für TRAILER-Bereich hinzugefügt
      - updateCranePixelPosition() erkennt jetzt TRAILER-Position
      - Wenn Y < 6000mm und X zwischen 30000-50000mm → TRAILER
      - PIXEL_TRAILER_X = 1150, PIXEL_TRAILER_Y = 590 (empirisch kalibriert)
      Datei: src/main/java/com/hydro/plsbl/ui/component/LagerGrid.java

2. [BEHOBEN] UI friert ein bei LagerView während Beladung

   Problem: UI friert ein wenn man zur LagerView wechselt während Beladung läuft

   Ursache: BeladungView hatte explizite ui.push() Aufrufe, die mit
   @Push(PushMode.AUTOMATIC) kollidieren können.

   Lösung: Entfernte redundante ui.push() Aufrufe in BeladungView
   - pollBeladungStatus(): ui.push() entfernt
   - pollBeladungOhneKran(): ui.push() entfernt
   PushMode.AUTOMATIC macht das automatisch nach ui.access()
   Datei: src/main/java/com/hydro/plsbl/ui/view/BeladungView.java

NÄCHSTE SCHRITTE:
-----------------------------------------------------------------------------

1. Oracle-Migration für MD_INGOTTYPE ausführen (inkl. SAW_TO_SWAPOUT Feld)
2. [ERLEDIGT] MITTEL-Barren: SWAPOUT-Logik implementiert (Stapler-Transport)
3. [ERLEDIGT] Auto-Auslagerung für MITTEL-Barren implementiert (autoRetrieval=true)
4. [ERLEDIGT] StaplerView erstellt (Übersicht offener Stapler-Anforderungen)
5. [ERLEDIGT] SWAPIN-Plätze definiert (YARD_TYPE='N')
6. [ERLEDIGT] MessageService + MeldungenView (Alarme quittieren)
7. [ERLEDIGT] Kran-Sicherheitsstopp bei offenen Türen
8. Regex-Matching für Produktnummern testen
9. MITTEL-Barren-Workflow testen (Einlagerung → SWAPOUT → extern → Auto-Auslagerung)
10. Echte PLC-Anbindung für Tür-/Tor-Status testen

=============================================================================
