=============================================================================
ENTWICKLUNGSSTAND - PLSBL Vaadin Starter
Stand: 26.01.2026
=============================================================================

AKTUELLES THEMA: Barrentypen-Berechtigungen implementieren
-----------------------------------------------------------------------------

ZIEL:
- Barrentypen konfigurierbar machen (KURZ, MITTEL, LANG)
- Längenbereiche statt fester Threshold
- Berechtigungen pro Typ (intern/extern, auslagerbar, auto)
- Gewichtslimits

ABGESCHLOSSENE ARBEITEN:
-----------------------------------------------------------------------------

1. [NEU 26.01.2026] MITTEL-Barren → SWAPOUT für Stapler-Transport

   Implementiert wie im Original-System: MITTEL-Barren werden nicht intern
   gelagert, sondern auf SWAPOUT-Plätze (Ausgang 00/xx) gelegt, wo der
   Stapler sie zu externen Lagerplätzen fährt.

   a) StockyardType Enum korrigiert:
      - SWAPOUT = 'A' (war vorher 'O', AUSGANG entfernt)
      - Wie im Original-System (StockyardType.java aus plsbl-pdo)
      Datei: src/main/java/com/hydro/plsbl/entity/enums/StockyardType.java

   b) Neues Feld sawToSwapout in IngotType:
      - Wenn true: Barren wird von Säge auf SWAPOUT-Platz gelegt
      - MITTEL-Barren haben sawToSwapout=true
      Dateien: IngotType.java, IngotTypeDTO.java, IngotTypeService.java

   c) IngotStorageService.findTargetStockyard() überarbeitet:
      - Prüft sawToSwapout ZUERST (vor intern/extern)
      - Wenn sawToSwapout=true → suche SWAPOUT-Platz (00/01-00/08)
      - Neue Methode findSwapoutYard() - sucht freie Ausgang-Plätze
      - Klare Log-Ausgabe: "*** STAPLER-TRANSPORT ERFORDERLICH ***"
      Datei: src/main/java/com/hydro/plsbl/service/IngotStorageService.java

   d) Testdaten aktualisiert (data-h2.sql):
      - Plätze 00/01 bis 00/08: YARD_TYPE='A' (SWAPOUT), MAX_INGOTS=1
      - MITTEL-Barrentyp: SAW_TO_SWAPOUT=TRUE

   e) Schema aktualisiert (schema-h2.sql):
      - Neues Feld SAW_TO_SWAPOUT in MD_INGOTTYPE

   f) Kran-Visualisierung für SWAPOUT-Bereich:
      - updateCranePixelPosition() erweitert
      - Neue Konstanten: MM_SWAPOUT_Y_MIN=11530, MM_SWAPOUT_Y_MAX=30830
      - PIXEL_SWAPOUT_X = PIXEL_SAW_X (Spalte 24 Mitte)
      - Kran wird korrekt über SWAPOUT-Plätzen 00/01-00/08 angezeigt
      Datei: src/main/java/com/hydro/plsbl/ui/component/LagerGrid.java

   g) Oracle SQL-Kompatibilität:
      - TO_STOCK_ALLOWED = 1 statt = TRUE (Oracle unterstützt kein TRUE)
      Datei: src/main/java/com/hydro/plsbl/repository/StockyardRepository.java

   h) Externe Plätze von Kran-Zielen ausgeschlossen:
      - findAvailableDestinations() filtert YARD_TYPE != 'E'
      - Externe Plätze werden nicht vom Kran bedient (Stapler-Transport)
      - Verhindert ungültige Kran-Bewegungen zu externen Plätzen
      Datei: src/main/java/com/hydro/plsbl/repository/StockyardRepository.java

   i) Manuelle Umbuchung ohne Kran (für Stapler-Transport):
      - Neue Methode findAvailableDestinationsIncludingExternal()
      - UmlagernDialog: "Nur Datenbank" Modus zeigt ALLE Plätze inkl. externe
      - "Mit Kran" Modus zeigt nur Kran-erreichbare Plätze
      - Ziel-Liste wird bei Modus-Wechsel automatisch neu geladen
      - Workflow: SWAPOUT-Platz → Stapler fährt → "Nur Datenbank" auf externen Platz buchen
      Dateien: StockyardRepository.java, StockyardService.java, UmlagernDialog.java

   j) Lagerplatz-Verwaltungsdialog (NEU):
      - StockyardManagementDialog mit Filter und Bearbeitungsfunktion
      - Filter nach: Typ (Intern, Extern, SWAPOUT), Verwendung (SHORT, LONG), Text-Suche
      - Grid-Ansicht aller Lagerplätze mit Sortierung
      - Bearbeitungsformular: Typ, Verwendung, Koordinaten, Kran-Position (mm),
        Max. Barren, Ein-/Auslagern erlaubt
      - Zugriff über: Einstellungen → Stammdaten → "Lagerplätze verwalten"
      Datei: src/main/java/com/hydro/plsbl/ui/dialog/StockyardManagementDialog.java

   Workflow für MITTEL-Barren (wie Original):
   1. Barren (4300-7400mm) kommt von Säge
   2. System erkennt: sawToSwapout=true, internalAllowed=false
   3. Kran legt Barren auf SWAPOUT-Platz (00/01, 00/02, etc.)
   4. Meldung im Log: "*** STAPLER-TRANSPORT ERFORDERLICH ***"
   5. Stapler holt Barren ab und fährt zu externem Lagerplatz
   6. Manuelle Buchung im System auf externen Platz

   Barrentyp-Berechtigungen (aus Stammdaten):
   | Name   | Intern | Extern | sawToSwapout | Effekt                      |
   |--------|--------|--------|--------------|------------------------------|
   | KURZ   | Ja     | Ja     | Nein         | Normal intern einlagern      |
   | LANG   | Ja     | Ja     | Nein         | Normal intern einlagern      |
   | MITTEL | Nein   | Ja     | Ja           | → SWAPOUT für Stapler        |

2. [NEU 25.01.2026] Barrentypen-System implementiert

   a) Neue Entity: IngotType (MD_INGOTTYPE)
      - Name, Beschreibung
      - LengthType (SHORT, MEDIUM, LONG)
      - Berechtigungen: internalAllowed, externalAllowed, retrievalAllowed, autoRetrieval
      - Längenbereiche: minLength, maxLength
      - Gewichtslimits: minWeight, maxWeight
      - Regex für Produktnummer-Matching
      - Priorität
      Datei: src/main/java/com/hydro/plsbl/entity/masterdata/IngotType.java

   b) Neues Enum: LengthType (SHORT, MEDIUM, LONG)
      Datei: src/main/java/com/hydro/plsbl/entity/enums/LengthType.java

   c) Neuer Service: IngotTypeService
      - CRUD-Operationen
      - determineIngotType() - ermittelt Barrentyp basierend auf Eigenschaften
      - determineLengthType() - für Rückwärtskompatibilität
      Datei: src/main/java/com/hydro/plsbl/service/IngotTypeService.java

   d) Neuer Dialog: IngotTypeDialog
      - Liste aller Barrentypen
      - Formular zum Anlegen/Bearbeiten
      - Alle Felder konfigurierbar
      Datei: src/main/java/com/hydro/plsbl/ui/dialog/IngotTypeDialog.java

   e) SettingsView erweitert
      - Tab "Stammdaten" mit Button "Barrentypen verwalten"
      Datei: src/main/java/com/hydro/plsbl/ui/view/SettingsView.java

   f) IngotStorageService angepasst
      - Verwendet jetzt IngotTypeService für Typ-Ermittlung
      - Fallback auf alte LONG_INGOT_THRESHOLD Logik wenn kein Typ passt
      Datei: src/main/java/com/hydro/plsbl/service/IngotStorageService.java

   g) Schema erweitert
      - H2: schema-h2.sql mit MD_INGOTTYPE Tabelle
      - H2: data-h2.sql mit Standard-Barrentypen (KURZ, LANG, MITTEL)
      - Oracle: schema-ingottype.sql für Migration
      Dateien: src/main/resources/schema-h2.sql, data-h2.sql, schema-ingottype.sql

   Standard-Barrentypen (aus barrentypen.xls):
   | Name   | Typ    | Länge (mm)   | Intern | Extern | Auslagerbar | Auto |
   |--------|--------|--------------|--------|--------|-------------|------|
   | KURZ   | SHORT  | 3500-4300    | Ja     | Ja     | Ja          | Nein |
   | LANG   | LONG   | 7500-8700    | Ja     | Ja     | Nein        | Nein |
   | MITTEL | MEDIUM | 4300-7400    | Nein   | Ja     | Ja          | Ja   |

2. [NEU 25.01.2026] Produkt-Verwaltung (Stammdaten)

   a) ProductService
      Datei: src/main/java/com/hydro/plsbl/service/ProductService.java

   b) ProductDialog
      Datei: src/main/java/com/hydro/plsbl/ui/dialog/ProductDialog.java

   c) SettingsView Tab "Stammdaten" mit "Artikel verwalten"

3. [NEU 25.01.2026] Bugfix: Barren-Löschen aktualisiert UI

   a) IngotService.delete() aktualisiert jetzt StockyardStatus
      Datei: src/main/java/com/hydro/plsbl/service/IngotService.java

   b) StockyardInfoDialog ruft onRelocated Callback nach Löschen
      Datei: src/main/java/com/hydro/plsbl/ui/dialog/StockyardInfoDialog.java

4. [NEU 25.01.2026] Test-Endpunkte erweitert

   a) GET /api/test/stockyards/usage/{usage}
      - ?available=true zeigt nur verfügbare Plätze
      - Zeigt ingotCount, maxIngots pro Platz

   b) GET /api/test/stockyard/{id}
      - Details zu einem Lagerplatz

5. [NEU 25.01.2026] Duplikat-Prüfung bei Einlagerung mit globaler Fehler-Notification

   a) IngotStorageService.checkIngotNotInStock()
      - Prüft vor Einlagerung ob Barren bereits im Lager existiert
      - Nur Barren die noch im Bestand sind (stockyardId != null) werden abgelehnt
      - Bereits ausgelieferte Barren (stockyardId = null) können erneut eingelagert werden
      - Fehlermeldung enthält Lagerplatz-Nummer für einfache Identifikation
      Datei: src/main/java/com/hydro/plsbl/service/IngotStorageService.java

   b) ErrorBroadcaster Service (NEU)
      - Zentraler Service für Fehler-Broadcasting an alle UI-Listener
      - Verwendet Executor für asynchrone Benachrichtigung
      - Registrierung über register() mit Consumer<ErrorMessage>
      Datei: src/main/java/com/hydro/plsbl/service/ErrorBroadcaster.java

   c) MainLayout - Globale Fehler-Notifications
      - Registriert sich beim ErrorBroadcaster
      - Zeigt Fehler als rote Notification in der Mitte des Bildschirms
      - Funktioniert in allen Views (nicht nur SawView)
      - Auto-Close nach 10 Sekunden + manueller X-Button
      Datei: src/main/java/com/hydro/plsbl/ui/MainLayout.java

6. [NEU 25.01.2026] LagerGrid Zaun-Verbesserungen

   a) Tor 3 (T3) hinzugefügt
      - Rechts neben der Säge im oberen Zaun
      - 20px breit (wie T7)
      - Position: Spalte 27, Reihe 2

   b) Zaun-Lücken geschlossen
      - Lücke bei Spalte 21 in Reihe 16 (mittlerer Zaun)
      - Lücke oberhalb 01/10 (topFence3 erweitert auf Spalte 21)
      - Lücke unterhalb 01/02 (bottomFence2 erweitert auf Spalte 21)
      - Lücke zwischen Säge und Zaun (topFence4a erweitert auf Spalte 24)
      Datei: src/main/java/com/hydro/plsbl/ui/component/LagerGrid.java

7. [NEU 25.01.2026] Vollständiges Oracle-Schema

   a) schema-oracle.sql erstellt
      - Alle 10 Tabellen für Oracle-Produktion
      - Stammdaten: MD_APPSETTING, MD_STOCKYARD, MD_PRODUCT, MD_INGOTTYPE
      - Bewegungsdaten: TD_STOCKYARDSTATUS, TD_INGOT, TD_CRANESTATUS,
                        TD_PLSSTATUS, TD_TRANSPORTORDER, TD_CALLOFF
      - Constraints (PK, FK, UK)
      - Indizes für Performance
      - Kommentare zu Tabellen und Spalten
      - Initiale Daten (Barrentypen, Status-Einträge, Einstellungen)
      Datei: src/main/resources/schema-oracle.sql

   b) CLAUDE.md aktualisiert
      - Vollständige Datenbank-Dokumentation
      - Schema-Dateien referenziert

FRÜHERE ARBEITEN:
-----------------------------------------------------------------------------

5. [ERLEDIGT] IngotStorageService.java - Längenbasierte Lagerplatz-Auswahl
6. [ERLEDIGT] Oracle-Profil aktiviert
7. [ERLEDIGT] Oracle-Kompatibilität - NOT NULL Spalten
8. [ERLEDIGT] Transport-Nummer Format gekürzt (TA26-0001)
9. [ERLEDIGT] Kran-Visualisierung korrigiert (LONG-Lagerplätze)

ORACLE-SCHEMA:
-----------------------------------------------------------------------------

Vollständiges Oracle-Schema in: src/main/resources/schema-oracle.sql

Tabellen (10):
  Stammdaten (MD_*):
    - MD_APPSETTING      Anwendungseinstellungen
    - MD_STOCKYARD       Lagerplätze
    - MD_PRODUCT         Produkte/Artikel
    - MD_INGOTTYPE       Barrentypen (KURZ, MITTEL, LANG)

  Bewegungsdaten (TD_*):
    - TD_STOCKYARDSTATUS Lagerplatz-Status
    - TD_INGOT           Barren
    - TD_CRANESTATUS     Kran-Status (1 Eintrag)
    - TD_PLSSTATUS       Säge-Status (1 Eintrag)
    - TD_TRANSPORTORDER  Transportaufträge
    - TD_CALLOFF         Abrufe/Kundenbestellungen

Migration:
  - Neues System: Vollständiges Script ausführen (schema-oracle.sql)
  - Bestehendes System: Nur MD_INGOTTYPE hinzufügen (schema-ingottype.sql)

ZUGRIFF auf neue Funktionen:
-----------------------------------------------------------------------------

1. Einstellungen → Tab "Stammdaten" → "Barrentypen verwalten"
2. Einstellungen → Tab "Stammdaten" → "Artikel verwalten"

NÄCHSTE SCHRITTE:
-----------------------------------------------------------------------------

1. Oracle-Migration für MD_INGOTTYPE ausführen (inkl. SAW_TO_SWAPOUT Feld)
2. [ERLEDIGT] MITTEL-Barren: SWAPOUT-Logik implementiert (Stapler-Transport)
3. Externe Plätze verwalten (Buchung ohne Kran, manuelle Umbuchung)
4. Auto-Auslagerung für MITTEL-Barren implementieren (autoRetrieval=true)
5. Regex-Matching für Produktnummern testen
6. MITTEL-Barren-Einlagerung testen (manuell über SawView)

=============================================================================
